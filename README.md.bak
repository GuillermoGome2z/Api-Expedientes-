# API de Gestion de Expedientes e Indicios# API de Gestion de Expedientes e Indicios



API REST desarrollada en TypeScript + Express con persistencia en SQL Server mediante procedimientos almacenados, autenticacion con JWT y control de roles.API REST desarrollada en **TypeScript + Express** con persistencia en **SQL Server** mediante procedimientos almacenados, autenticacion con **JWT** y control de roles (tecnico y coordinador).



**Proyecto:** Desarrollo Web - Universidad Mariano Galvez (2025)Proyecto entregado para la clase de **Desarrollo Web - Universidad Mariano Galvez (2025)**.



------



## Caracteristicas## Caracteristicas



- Autenticacion JWT con bcrypt- Autenticacion con JWT (bcrypt para hash de contrasenas)

- Roles: Tecnico y Coordinador- Roles: Tecnico y Coordinador

- CRUD completo de Expedientes e Indicios- CRUD completo de Expedientes e Indicios

- Flujo de aprobacion de expedientes- Flujo de aprobacion de expedientes (aprobado/rechazado con justificacion)

- Validaciones con express-validator- Eliminacion logica mediante campo `activo`

- Filtros avanzados: estado, tecnico, rango de fechas, busqueda- Validaciones con express-validator:

- Paginacion en listados  - Codigo de expediente unico

- Exportacion a Excel  - Peso mayor o igual a 0

- Campos de auditoria automaticos  - Control de permisos por rol

- Validacion de ownership (tecnicos solo modifican sus expedientes)  - Validacion de ownership (tecnicos solo pueden modificar sus expedientes)

- Eliminacion logica con campo `activo`- Filtros avanzados: estado, tecnicoId, rango de fechas, busqueda por texto

- Documentacion Swagger UI completa- Paginacion en listados

- Exportacion a Excel con filtros aplicados

---- Campos de auditoria: fecha_creacion, fecha_actualizacion, modificado_por

- Documentacion con Swagger UI en `/docs`

## Tecnologias- Scripts SQL completos (schema + seed + stored procedures)



- **Backend:** TypeScript 5.9, Express 5.1, Node.js---

- **Base de datos:** SQL Server 2022 (Docker)

- **Autenticacion:** JWT + bcrypt## Estructura del proyecto

- **Validacion:** express-validator

- **Documentacion:** Swagger UI```

- **Exportacion:** xlsxsrc/

‚îú‚îÄ controllers/     # Logica de negocio

---‚îú‚îÄ routes/          # Definicion de endpoints

‚îú‚îÄ middlewares/     # Autenticacion, validacion, roles

## Instalacion rapida‚îú‚îÄ db/

‚îÇ  ‚îú‚îÄ db.ts        # Conexion a SQL Server

### 1. Clonar repositorio‚îÇ  ‚îî‚îÄ sp/          # Stored procedures

```bash‚îú‚îÄ auth/           # Utilidades JWT

git clone https://github.com/GuillermoGome2z/Api-Expedientes-.git‚îú‚îÄ scripts/        # Schema y seed SQL

cd Api-Expedientes-‚îî‚îÄ swagger.ts      # Documentacion OpenAPI

``````



### 2. Instalar dependencias---

```bash

npm install---

```

## ‚öôÔ∏è Instalaci√≥n y ejecuci√≥n

### 3. Configurar variables de entorno

Crear archivo `.env`:### 1Ô∏è‚É£ Clonar el repositorio

```env```bash

PORT=3000git clone https://github.com/GuillermoGome2z/Api-Expedientes-.git

JWT_SECRET=tu_secreto_super_segurocd Api-Expedientes-

JWT_EXPIRES=1h```

DB_SERVER=localhost

DB_USER=sa### 2Ô∏è‚É£ Instalar dependencias

DB_PASS=YourStrong!Passw0rd```bash

DB_NAME=expedientes_dbnpm install

BCRYPT_SALT_ROUNDS=10```

```

### 3 - Configurar variables de entorno

### 4. Levantar SQL Server con Docker

```bashCrear archivo `.env` en la raiz del proyecto:

docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=YourStrong!Passw0rd" \

  -p 1433:1433 --name sqlserver -d mcr.microsoft.com/mssql/server:2022-latest```env

```PORT=3000

JWT_SECRET=tu_secreto_super_seguro

### 5. Inicializar base de datos (PowerShell)JWT_EXPIRES=1h

```powershellDB_SERVER=localhost

# Crear estructuraDB_USER=sa

Get-Content .\src\scripts\schema.sql | docker exec -i sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -CDB_PASS=YourStrong!Passw0rd

DB_NAME=expedientes_db

# Insertar datosBCRYPT_SALT_ROUNDS=10

Get-Content .\src\scripts\seed.sql | docker exec -i sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -C```



# Crear stored procedures### 4 - Levantar SQL Server con Docker

Get-ChildItem -Path .\src\db\sp\**\*.sql | ForEach-Object { 

  Get-Content $_.FullName | docker exec -i sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -C -d expedientes_db ```bash

}docker run -e "ACCEPT_EULA=Y" -e "MSSQL_SA_PASSWORD=YourStrong!Passw0rd" \

```  -p 1433:1433 --name sqlserver -d mcr.microsoft.com/mssql/server:2022-latest

```

### 6. Ejecutar servidor

```bash### 5 - Inicializar base de datos

npm run dev

```**PowerShell:**

```powershell

Servidor disponible en: http://localhost:3000# Crear base de datos y tablas

Get-Content .\src\scripts\schema.sql | docker exec -i sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -C

---

# Insertar datos de prueba

## Endpoints principalesGet-Content .\src\scripts\seed.sql | docker exec -i sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -C



### Autenticacion# Crear stored procedures

- `POST /api/auth/login` - Login con username/passwordGet-ChildItem -Path .\src\db\sp\usuarios\*.sql | ForEach-Object { 

  Get-Content $_.FullName | docker exec -i sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -C -d expedientes_db 

### Usuarios (coordinador)}

- `POST /api/usuarios` - Crear usuario

- `GET /api/usuarios` - Listar usuariosGet-ChildItem -Path .\src\db\sp\expedientes\*.sql | ForEach-Object { 

- `PATCH /api/usuarios/:id/password` - Cambiar contrasena  Get-Content $_.FullName | docker exec -i sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -C -d expedientes_db 

}

### Expedientes

- `GET /api/expedientes` - Listar con filtros (estado, tecnicoId, fechas, q)Get-ChildItem -Path .\src\db\sp\indicios\*.sql | ForEach-Object { 

- `POST /api/expedientes` - Crear (tecnico)  Get-Content $_.FullName | docker exec -i sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong!Passw0rd" -C -d expedientes_db 

- `PUT /api/expedientes/:id` - Actualizar (tecnico dueno)}

- `PATCH /api/expedientes/:id/estado` - Aprobar/rechazar (coordinador)```

- `GET /api/expedientes/export` - Exportar a Excel

**Opci√≥n 2 - SSMS o DBeaver (Manual):**

### Indicios1. Conectarse a SQL Server (localhost:1433, usuario: sa)

- `GET /api/expedientes/:id/indicios` - Listar con paginacion2. Ejecutar `src/scripts/schema.sql` (crea base de datos y tablas con campos de auditor√≠a)

- `POST /api/expedientes/:id/indicios` - Crear (tecnico dueno)3. Ejecutar `src/scripts/seed.sql` (inserta 3 usuarios, 5 expedientes, 8 indicios)

- `PUT /api/indicios/:id` - Actualizar (tecnico dueno)4. Ejecutar todos los stored procedures en orden:

   - `src/db/sp/usuarios/*.sql`

---   - `src/db/sp/expedientes/*.sql`

   - `src/db/sp/indicios/*.sql`

## Pruebas

### 6Ô∏è‚É£ Ejecutar la API

### Credenciales de prueba

- **Tecnico 1:** `tecnico1` / `tecnico123`**Desarrollo:**

- **Tecnico 2:** `tecnico2` / `tecnico123````bash

- **Coordinador:** `coord1` / `tecnico123`npm run dev

```

### Swagger UI (recomendado)

1. Abrir http://localhost:3000/docs**Producci√≥n:**

2. Click en `POST /api/auth/login````bash

3. Probar con credenciales de arribanpm run build

4. Copiar el token de la respuestanpm start

5. Click en "Authorize" y pegar: `Bearer <token>````

6. Probar todos los endpoints

El servidor estar√° disponible en: http://localhost:3000

### PowerShell

```powershell**Verificar que todo funciona:**

# Login1. Abre http://localhost:3000/docs (deber√≠a mostrar Swagger UI)

$response = Invoke-RestMethod -Uri http://localhost:3000/api/auth/login `2. Prueba el endpoint de salud: http://localhost:3000/api/health

  -Method POST -ContentType "application/json" `3. Haz login con las credenciales de prueba (ver secci√≥n de Pruebas)

  -Body '{"username":"tecnico1","password":"tecnico123"}'

---

$token = $response.token## üìñ Endpoints principales



# Listar expedientes### üîê Auth

$headers = @{ Authorization = "Bearer $token" }- `POST /api/auth/login` ‚Üí Iniciar sesi√≥n y obtener JWT

Invoke-RestMethod -Uri http://localhost:3000/api/expedientes -Headers $headers

```### ÔøΩ Usuarios

- `POST /api/usuarios` ‚Üí Crear usuario (solo coordinador)

### Curl- `PATCH /api/usuarios/:id/password` ‚Üí Cambiar contrase√±a

```bash- `GET /api/usuarios` ‚Üí Listar usuarios (solo coordinador)

# Login

TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/login \### ÔøΩüìÇ Expedientes

  -H "Content-Type: application/json" \- `GET /api/expedientes?page=1&pageSize=10&estado=abierto&fechaInicio=2025-01-01&fechaFin=2025-12-31&tecnicoId=1` ‚Üí Listar con filtros avanzados

  -d '{"username":"tecnico1","password":"tecnico123"}' | jq -r '.token')- `GET /api/expedientes/:id` ‚Üí Obtener detalle

- `POST /api/expedientes` ‚Üí Crear (solo t√©cnico)

# Listar expedientes- `PUT /api/expedientes/:id` ‚Üí Actualizar (solo t√©cnico due√±o)

curl -X GET http://localhost:3000/api/expedientes \- `PATCH /api/expedientes/:id/estado` ‚Üí Aprobar/rechazar (solo coordinador)

  -H "Authorization: Bearer $TOKEN"- `PATCH /api/expedientes/:id/activo` ‚Üí Soft delete

```- `GET /api/expedientes/export?estado=aprobado` ‚Üí Exportar a Excel



Mas ejemplos en `docs/tests-rapidos.md`### üîé Indicios

- `GET /api/expedientes/:id/indicios?page=1&pageSize=10` ‚Üí Listar con paginaci√≥n

---- `POST /api/expedientes/:id/indicios` ‚Üí Crear (solo t√©cnico due√±o del expediente)

- `PUT /api/indicios/:id` ‚Üí Actualizar (solo t√©cnico due√±o)

## Documentacion- `PATCH /api/indicios/:id/activo` ‚Üí Soft delete (solo t√©cnico due√±o)



- **Swagger UI:** http://localhost:3000/docs### ÔøΩ Nuevas caracter√≠sticas

- **Health check:** http://localhost:3000/api/health- **Filtros avanzados:** estado, fechaInicio, fechaFin, tecnicoId

- **Tests completos:** docs/tests-rapidos.md- **Paginaci√≥n:** Soporta `page`/`pagina` y `pageSize`

- **Repositorio:** https://github.com/GuillermoGome2z/Api-Expedientes-- **Validaci√≥n de ownership:** T√©cnicos solo pueden modificar sus propios expedientes/indicios

- **Auditor√≠a:** Campos `fecha_creacion`, `fecha_actualizacion`, `modificado_por`

---- **Exportaci√≥n:** Excel con filtros aplicados



## Datos de seed## ÔøΩüìë Documentaci√≥n

- **Swagger UI:** http://localhost:3000/docs

- **3 usuarios:** 2 tecnicos + 1 coordinador- **Health check:** http://localhost:3000/api/health

- **5 expedientes:** 3 abiertos, 1 aprobado, 1 rechazado- **Tests r√°pidos:** Ver `docs/tests-rapidos.md` para comandos curl completos

- **8 indicios:** distribuidos entre expedientes- La ruta ra√≠z `/` redirige autom√°ticamente a `/docs`



---## üß™ Credenciales de prueba



## AutorLos datos de seed incluyen:



**Guillermo Gomez****Usuarios:**

- GitHub: [@GuillermoGome2z](https://github.com/GuillermoGome2z)- T√©cnico 1: `tecnico1` / `tecnico123`

- Universidad Mariano Galvez - Desarrollo Web (2025)- T√©cnico 2: `tecnico2` / `tecnico123`

- Coordinador: `coord1` / `tecnico123`

---

**Expedientes de prueba:** 5 expedientes

## Licencia- 3 abiertos (2 de tecnico1, 1 de tecnico2)

- 1 aprobado (tecnico2)

ISC- 1 rechazado con justificaci√≥n (tecnico1)


**Indicios de prueba:** 8 indicios distribuidos entre expedientes

---

## üß™ C√≥mo hacer pruebas

### Opci√≥n 1: Swagger UI (Recomendado)
1. Abre http://localhost:3000/docs en tu navegador
2. Haz clic en **POST /api/auth/login**
3. Click en "Try it out"
4. Pega las credenciales:
   ```json
   {
     "username": "tecnico1",
     "password": "tecnico123"
   }
   ```
5. Click en "Execute"
6. Copia el `token` de la respuesta
7. Haz clic en el bot√≥n "Authorize" (arriba a la derecha)
8. Pega el token: `Bearer tu_token_aqui`
9. Ahora puedes probar todos los endpoints autenticados

### Opci√≥n 2: PowerShell con Invoke-WebRequest
```powershell
# 1. Login y obtener token
$loginResponse = Invoke-RestMethod -Uri http://localhost:3000/api/auth/login `
  -Method POST `
  -ContentType "application/json" `
  -Body '{"username":"tecnico1","password":"tecnico123"}'

$token = $loginResponse.token
Write-Host "Token obtenido: $token"

# 2. Listar expedientes
$headers = @{ Authorization = "Bearer $token" }
$expedientes = Invoke-RestMethod -Uri http://localhost:3000/api/expedientes `
  -Method GET -Headers $headers
$expedientes | ConvertTo-Json

# 3. Crear expediente
$body = @{
  codigo = "TEST-$(Get-Date -Format 'yyyyMMddHHmmss')"
  titulo = "Expediente de prueba"
  descripcion = "Creado desde PowerShell"
} | ConvertTo-Json

$nuevoExp = Invoke-RestMethod -Uri http://localhost:3000/api/expedientes `
  -Method POST -Headers $headers -ContentType "application/json" -Body $body
$nuevoExp | ConvertTo-Json

# 4. Exportar a Excel (abre en navegador)
Start-Process "http://localhost:3000/api/expedientes/export?estado=abierto"
```

### Opci√≥n 3: curl (Bash/Git Bash)
```bash
# 1. Login
TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"username":"tecnico1","password":"tecnico123"}' | jq -r '.token')

echo "Token: $TOKEN"

# 2. Listar expedientes con filtros
curl -X GET "http://localhost:3000/api/expedientes?estado=abierto&page=1&pageSize=10" \
  -H "Authorization: Bearer $TOKEN"

# 3. Crear expediente
curl -X POST http://localhost:3000/api/expedientes \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"codigo":"TEST-001","titulo":"Test","descripcion":"Expediente de prueba"}'

# 4. Aprobar expediente (requiere rol coordinador)
curl -X PATCH http://localhost:3000/api/expedientes/1/estado \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN_COORDINADOR" \
  -d '{"nuevoEstado":"aprobado"}'
```

### Opci√≥n 4: Postman / Insomnia
1. Importa la URL de Swagger: `http://localhost:3000/docs`
2. O crea las peticiones manualmente siguiendo la documentaci√≥n
3. Configura el header `Authorization: Bearer <token>` despu√©s del login

### Tests completos
Ver `docs/tests-rapidos.md` para m√°s de 30 ejemplos de pruebas con casos de √©xito y error, validaci√≥n de ownership, paginaci√≥n, filtros y exportaci√≥n.

---

## üé® Frontend Integration

Esta API est√° dise√±ada para trabajar con el frontend incluido en la carpeta `frontend/` (React + TypeScript + Vite).

### Configuraci√≥n del Frontend

El frontend usa la variable de entorno `VITE_API_BASE_URL` para conectarse a la API. Esta debe configurarse seg√∫n el `BASE_PATH` del backend:

**Ejemplo `.env` en `frontend/`:**
```env
VITE_API_BASE_URL=http://localhost:3000/api
```

Si cambias `BASE_PATH` en el backend (por ejemplo a `/v1` o `/api/v2`), actualiza tambi√©n el frontend:

```env
# Backend .env
BASE_PATH=/api/v2

# Frontend .env
VITE_API_BASE_URL=http://localhost:3000/api/v2
```

### CORS

El backend acepta peticiones desde los siguientes or√≠genes por defecto:
- `http://localhost:5173` (Vite dev server)
- `http://localhost:3001`
- `http://localhost:3000`

Para configurar or√≠genes personalizados, usa la variable `CORS_ORIGIN` en el `.env` del backend:

```env
CORS_ORIGIN=http://localhost:5173,https://mi-dominio.com
```

### Paginaci√≥n: Aliases en espa√±ol

La API soporta aliases en espa√±ol para los par√°metros de paginaci√≥n:

| Ingl√©s       | Espa√±ol (alias) | Ejemplo                                |
|--------------|-----------------|----------------------------------------|
| `page`       | `pagina`        | `?page=2` o `?pagina=2`                |
| `pageSize`   | `tamanoPagina`  | `?pageSize=20` o `?tamanoPagina=20`    |

Esto permite que el frontend use t√©rminos en espa√±ol sin necesidad de traducci√≥n adicional.

**Ejemplo de uso:**
```javascript
// Ambas formas funcionan
fetch(`${API_BASE_URL}/expedientes?page=1&pageSize=10`)
fetch(`${API_BASE_URL}/expedientes?pagina=1&tamanoPagina=10`)
```

---

## üë®‚Äçüíª Autor

**Guillermo G√≥mez**
- GitHub: [@GuillermoGome2z](https://github.com/GuillermoGome2z)
- Universidad Mariano G√°lvez - Desarrollo Web (2025)

---

## üìÑ Licencia

ISC
